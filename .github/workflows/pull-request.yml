name: Pull Request
on:
  push:
    branches:
      - 'DIC1-*'
      - 'IS-*'


jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ENABLE_SECRETS_SCAN: true
      ENABLE_DEPENDENCIES_SCAN: false
      ENABLE_TESTS: true
      ENABLE_SONAR_SCAN: false

    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./.github/actions/setup-env

      - uses: ./.github/actions/secrets-scan
        with:
          ENABLED: ${{ env.ENABLE_SECRETS_SCAN }}

      - uses: ./.github/actions/dependency-scan
        with:
          ENABLED: ${{ env.ENABLE_DEPENDENCIES_SCAN }}
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}

      - uses: ./.github/actions/tests
        with:
          ENABLED: ${{ env.ENABLE_TESTS }}

      - uses: ./.github/actions/quality-gate
        with:
          ENABLED: ${{ env.ENABLE_SONAR_SCAN }}
          PROJECT_KEY: "seenibu_todos"
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST: "https://sonarcloud.io"

      - uses: ./.github/actions/package

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t my-app:latest .

      - name: Install Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: my-app:latest
          format: json #json,xml,table
          exit-code: 0 # 1: échoue si vulnérabilités trouvées, 0 : sinon. Remettre a 1
          severity: CRITICAL,HIGH #unknown, low,medium, high, critical
          ignore-unfixed: true #ignore celles qui n'ont pas de correctifs


      - name: Run ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'https://concours.ept.sn/'
          fail_action: true
          format: HTML
#          allow_issue_writing: true
#          token: ${{ secrets.GITHUB_TOKEN }}
#          cmd_options: '-config globalexcludeurl.url_list="^https://example.com/logout.*"'
#          rules_file_name: '.zap/rules.tsv'  # Facultatif : fichier pour ajuster les niveaux d'alerte

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_report_html.html